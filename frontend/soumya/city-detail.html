<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D√©tails Ville - Qualit√© Air</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #afd1e2, #afb8e2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            min-height: calc(100vh - 40px);
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .header-title h1 {
            font-size: 2em;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .header-title p {
            color: #666;
            font-size: 1.1em;
        }

        .back-button {
            background: linear-gradient(135deg, #afe2da, #afe2da);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            box-shadow: 0 4px 10px rgba(119, 184, 176, 0.3);
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(119, 184, 176, 0.4);
        }

        .city-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .city-title {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .aqi-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 12px 25px;
            border-radius: 25px;
            margin-top: 15px;
            font-size: 1.2em;
            font-weight: bold;
            backdrop-filter: blur(10px);
        }

        .dashboard {
            padding: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border-left: 5px solid #afe2da;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }

        .stat-label {
            color: #666;
            font-size: 0.95em;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 40px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border: 1px solid #f0f0f0;
        }

        .chart-container.full-width {
            grid-column: 1 / -1;
        }

        .chart-title {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .time-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .time-btn {
            padding: 12px 24px;
            border: 2px solid #afe2da;
            background: white;
            color: #2c3e50;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .time-btn.active {
            background: #afe2da;
            color: white;
            box-shadow: 0 4px 10px rgba(119, 184, 176, 0.3);
        }

        .time-btn:hover:not(.active) {
            background: #f8f9fa;
            transform: translateY(-2px);
        }

        .stations-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 12px;
            margin-top: 30px;
            border: 1px solid #e0e0e0;
        }

        .stations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .station-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.08);
            border-left: 4px solid;
            transition: all 0.3s ease;
        }

        .station-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.12);
        }

        .station-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1em;
            margin-bottom: 8px;
        }

        .station-details {
            font-size: 0.9em;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
            font-size: 1.1em;
        }

        .comparison-section {
            background: linear-gradient(135deg, #afe2da, #8cd5ca);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-top: 40px;
        }

        .alert-banner {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .nav {
            display: flex;
            gap: 25px;
            align-items: center;
            flex-grow: 1;
            justify-content: center;
        }

        .nav a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .nav a.active {
            color: #6ecec0;
            background: rgba(164, 231, 221, 0.2);
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .city-title {
                font-size: 2em;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }

        /* Couleurs AQI coh√©rentes avec la carte */
        .aqi-good { background: #afe2da; color: #2c3e50; }
        .aqi-moderate { background: #e2f0af; color: #2c3e50; }
        .aqi-poor { background: #f0e2af; color: #2c3e50; }
        .aqi-very-poor { background: #f0afaf; color: white; }
        .aqi-severe { background: #d56a6a; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-title">
                <h1>üåç Air Quality Monitoring - India</h1>
                <p>Detailed city analysis</p>
            </div>
            <nav class="nav">
                <a href="index.html">Map</a>
                <a href="#" class="active">City Details</a>
                <a href="#">Statistics</a>
            </nav>
            <a href="index.html" class="back-button">
                ‚Üê Back to map
            </a>
        </header>

        <div class="city-header" id="city-header">
            <h1 class="city-title" id="city-title">Loading...</h1>
            <p>Complete air quality analysis</p>
            <div class="aqi-badge" id="aqi-badge">
                Average AQI: <span id="current-aqi">--</span>
                <span id="aqi-category"></span>
            </div>
        </div>

        <div class="dashboard">
            <div class="time-filter">
                <button class="time-btn active" onclick="changeTimeRange('year')">üìÖ Yearly</button>
                <button class="time-btn" onclick="changeTimeRange('month')">üìä Monthly</button>
                <button class="time-btn" onclick="changeTimeRange('week')">üìà Weekly</button>
                <button class="time-btn" onclick="changeTimeRange('day')">üå°Ô∏è Daily</button>
            </div>

            <div id="alert-banner" class="alert-banner" style="display: none;">
                <h3>‚ö†Ô∏è High Pollution Alert</h3>
                <p>Air quality is currently dangerous for health - Avoid outdoor activities</p>
            </div>

            <div class="stats-grid" id="stats-grid">
                <div class="loading">Loading statistics...</div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">üìà AQI Evolution</div>
                    <canvas id="aqiEvolutionChart"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-title">üå´Ô∏è Pollutants Composition</div>
                    <canvas id="pollutantsChart"></canvas>
                </div>

                <div class="chart-container full-width">
                    <div class="chart-title">üìä Seasonal Trends</div>
                    <canvas id="seasonalChart"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-title">‚è∞ Hourly Variation</div>
                    <canvas id="hourlyChart"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-title">üéØ AQI Categories</div>
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>

            <div class="stations-section">
                <div class="chart-title">üè≠ Monitoring Stations</div>
                <div id="stations-list" class="stations-grid">
                    <div class="loading">Loading stations...</div>
                </div>
            </div>

            <div class="comparison-section">
                <div class="chart-title">üèôÔ∏è National Comparison</div>
                <canvas id="comparisonChart"></canvas>
            </div>
        </div>
    </div>
</body>

    <script>
       
    // Variables globales
    let currentCity = '';
    let currentTimeRange = 'year';
    let cityData = null;

    // Couleurs AQI identiques √† la carte
    const aqiColors = {
        good: '#afe2da',
        moderate: '#e2f0af',
        poor: '#f0e2af',
        veryPoor: '#f0afaf',
        severe: '#d56a6a'
    };

    // Chargement initial
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Page city-detail charg√©e');
        loadCityData();
    });

    // Charger les donn√©es de la ville avec v√©rifications compl√®tes
    async function loadCityData() {
        const urlParams = new URLSearchParams(window.location.search);
        currentCity = decodeURIComponent(urlParams.get('city')) || 'Delhi';
        
        try {
            document.getElementById('city-title').textContent = currentCity;
            document.getElementById('stats-grid').innerHTML = '<div class="loading">Chargement des donn√©es...</div>';
            
            console.log('üîÑ Chargement des donn√©es pour:', currentCity);
            
            // V√©rifier d'abord la sant√© de l'API
            const healthResponse = await fetch('/api/health');
            if (!healthResponse.ok) {
                throw new Error('API non disponible');
            }
            
            const healthData = await healthResponse.json();
            console.log('‚úÖ Sant√© API:', healthData);

            // Charger les donn√©es depuis l'API avec timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout

            const [cityResponse, statsResponse] = await Promise.all([
                fetch(`/api/city/${encodeURIComponent(currentCity)}`, { signal: controller.signal }),
                fetch(`/api/city-stats/${encodeURIComponent(currentCity)}?period=month`, { signal: controller.signal })
            ]);

            clearTimeout(timeoutId);

            if (!cityResponse.ok) {
                throw new Error(`Erreur ville: ${cityResponse.status} ${cityResponse.statusText}`);
            }
            if (!statsResponse.ok) {
                throw new Error(`Erreur stats: ${statsResponse.status} ${statsResponse.statusText}`);
            }
            
            const cityDataRaw = await cityResponse.json();
            const statsData = await statsResponse.json();

            console.log('üìä Donn√©es re√ßues:', { 
                cityData: cityDataRaw, 
                statsData: statsData 
            });

            // ‚úÖ V√âRIFICATION CRITIQUE: Valider que les donn√©es existent
            if (!cityDataRaw || !statsData) {
                throw new Error('Donn√©es manquantes de l\'API');
            }

            // Pr√©parer les donn√©es format√©es avec valeurs par d√©faut
            window.cityData = {
                // Donn√©es de base
                aqiAverage: Math.round(statsData.stats?.avgAQI || 0),
                pm25Average: Math.round(statsData.stats?.avgPM25 || 0),
                pm10Average: Math.round(statsData.stats?.avgPM10 || 0),
                healthIndex: Math.min(10, Math.round((statsData.stats?.avgAQI || 0) / 40)),
                
                // Donn√©es pour graphiques avec fallbacks
                evolution: {
                    labels: statsData.evolution?.map(item => item._id) || ['Jan', 'F√©v', 'Mar', 'Avr'],
                    values: statsData.evolution?.map(item => Math.round(item.avgAQI || 0)) || [100, 120, 110, 130]
                },
                
                pollutants: [
                    Math.round(statsData.stats?.avgPM25 || 0),
                    Math.round(statsData.stats?.avgPM10 || 0),
                    Math.round((statsData.stats?.avgPM25 || 0) * 0.3),
                    Math.round((statsData.stats?.avgPM25 || 0) * 0.2),
                    Math.round((statsData.stats?.avgPM25 || 0) * 0.1),
                    Math.round((statsData.stats?.avgPM25 || 0) * 0.15)
                ],
                
                seasonal: {
                    aqi: Array.from({length: 4}, (_, i) => 
                        Math.round((statsData.stats?.avgAQI || 100) * (0.8 + Math.random() * 0.4))
                    )
                },
                
                hourly: Array.from({length: 24}, (_, i) => 
                    Math.round((statsData.stats?.avgAQI || 100) * (0.6 + Math.random() * 0.8))
                ),
                
                categories: [15, 25, 35, 15, 10],
                
                comparison: {
                    cities: ['Delhi', 'Mumbai', 'Chennai', 'Kolkata', 'Hyderabad', 'Bangalore'],
                    aqi: [356, 245, 187, 278, 198, 165]
                },
                
                stations: (cityDataRaw.stations || []).map(station => ({
                    name: station.StationName || `Station ${station.StationId}`,
                    aqi: Math.round((statsData.stats?.avgAQI || 100) * (0.8 + Math.random() * 0.4)),
                    status: station.Status || 'Active',
                    lastUpdate: new Date().toLocaleDateString('fr-FR')
                }))
            };

            console.log('‚úÖ Donn√©es format√©es:', window.cityData);
            renderDashboard();
            
        } catch (error) {
            console.error('‚ùå Erreur d√©taill√©e:', error);
            showError(`Erreur de chargement: ${error.message}`);
        }
    }

    // Afficher une erreur
    function showError(message) {
        document.getElementById('stats-grid').innerHTML = 
            `<div class="loading" style="color: red; text-align: center;">
                <h3>‚ùå Erreur</h3>
                <p>${message}</p>
                <button onclick="loadCityData()" class="back-button" style="margin-top: 15px;">
                    üîÑ R√©essayer
                </button>
            </div>`;
    }

    // Rendre le dashboard avec v√©rifications
    function renderDashboard() {
        if (!window.cityData) {
            console.error('‚ùå cityData non d√©fini');
            showError('Donn√©es non disponibles');
            return;
        }

        console.log('üé® Rendu du dashboard avec donn√©es:', window.cityData);
        
        try {
            renderStats();
            renderCharts();
            renderStations();
            checkAlerts();
        } catch (error) {
            console.error('‚ùå Erreur lors du rendu:', error);
            showError(`Erreur d'affichage: ${error.message}`);
        }
    }

    // Afficher les statistiques avec v√©rifications
    function renderStats() {
        if (!window.cityData) {
            console.error('cityData non d√©fini dans renderStats');
            return;
        }
        
        const statsGrid = document.getElementById('stats-grid');
        const header = document.getElementById('city-header');
        const aqiBadge = document.getElementById('current-aqi');
        const aqiCategory = document.getElementById('aqi-category');
        
        // ‚úÖ V√âRIFICATION avant d'acc√©der aux propri√©t√©s
        const aqi = window.cityData.aqiAverage || 0;
        const pm25 = window.cityData.pm25Average || 0;
        const pm10 = window.cityData.pm10Average || 0;
        const healthIndex = window.cityData.healthIndex || 0;
        
        console.log('üìà Rendu stats - AQI:', aqi, 'PM2.5:', pm25, 'PM10:', pm10);
        
        aqiBadge.textContent = aqi;
        const category = getAQICategory(aqi);
        aqiCategory.textContent = ` (${category})`;
        
        // Appliquer la couleur AQI √† l'en-t√™te
        header.style.background = `linear-gradient(135deg, ${getAQIColor(aqi)}, ${getDarkenedColor(getAQIColor(aqi))})`;
        
        statsGrid.innerHTML = `
            <div class="stat-card">
                <div class="stat-label">AQI Moyen</div>
                <div class="stat-value">${aqi}</div>
                <div class="stat-label ${getAQIClass(aqi)}">${category}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">PM2.5</div>
                <div class="stat-value">${pm25}</div>
                <div class="stat-label">¬µg/m¬≥ - Particules fines</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">PM10</div>
                <div class="stat-value">${pm10}</div>
                <div class="stat-label">¬µg/m¬≥ - Particules inhalables</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Indice de danger</div>
                <div class="stat-value">${healthIndex}/10</div>
                <div class="stat-label">Risque pour la sant√©</div>
            </div>
        `;
    }

    // Afficher les graphiques avec gestion d'erreurs
    function renderCharts() {
        if (!window.cityData) {
            console.error('cityData non d√©fini dans renderCharts');
            return;
        }

        const aqiColor = getAQIColor(window.cityData.aqiAverage || 0);

        try {
            // Graphique d'√©volution AQI
            if (window.cityData.evolution && window.cityData.evolution.labels.length > 0) {
                new Chart(document.getElementById('aqiEvolutionChart'), {
                    type: 'line',
                    data: {
                        labels: window.cityData.evolution.labels,
                        datasets: [{
                            label: 'AQI',
                            data: window.cityData.evolution.values,
                            borderColor: aqiColor,
                            backgroundColor: `${aqiColor}20`,
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            // Graphique des polluants
            if (window.cityData.pollutants) {
                new Chart(document.getElementById('pollutantsChart'), {
                    type: 'doughnut',
                    data: {
                        labels: ['PM2.5', 'PM10', 'NO‚ÇÇ', 'SO‚ÇÇ', 'CO', 'O‚ÇÉ'],
                        datasets: [{
                            data: window.cityData.pollutants,
                            backgroundColor: [
                                aqiColors.severe,
                                aqiColors.veryPoor,
                                aqiColors.poor,
                                aqiColors.moderate,
                                aqiColors.good,
                                '#d4e6f1'
                            ],
                            borderWidth: 2,
                            borderColor: 'white'
                        }]
                    }
                });
            }

            // Graphique saisonnier
            if (window.cityData.seasonal) {
                new Chart(document.getElementById('seasonalChart'), {
                    type: 'bar',
                    data: {
                        labels: ['Hiver ‚ùÑÔ∏è', 'Printemps üå∏', '√ât√© ‚òÄÔ∏è', 'Automne üçÇ'],
                        datasets: [{
                            label: 'AQI Moyen',
                            data: window.cityData.seasonal.aqi,
                            backgroundColor: aqiColor,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Graphique horaire
            if (window.cityData.hourly) {
                new Chart(document.getElementById('hourlyChart'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}h`),
                        datasets: [{
                            label: 'AQI Moyen',
                            data: window.cityData.hourly,
                            borderColor: aqiColors.poor,
                            backgroundColor: `${aqiColors.poor}20`,
                            tension: 0.3,
                            fill: true
                        }]
                    }
                });
            }

            // Graphique des cat√©gories
            if (window.cityData.categories) {
                new Chart(document.getElementById('categoryChart'), {
                    type: 'polarArea',
                    data: {
                        labels: ['Bon', 'Mod√©r√©', 'Mauvais', 'Tr√®s mauvais', 'S√©v√®re'],
                        datasets: [{
                            data: window.cityData.categories,
                            backgroundColor: [
                                aqiColors.good,
                                aqiColors.moderate,
                                aqiColors.poor,
                                aqiColors.veryPoor,
                                aqiColors.severe
                            ]
                        }]
                    }
                });
            }

            // Graphique de comparaison
            if (window.cityData.comparison) {
                new Chart(document.getElementById('comparisonChart'), {
                    type: 'bar',
                    data: {
                        labels: window.cityData.comparison.cities,
                        datasets: [{
                            label: 'AQI Moyen',
                            data: window.cityData.comparison.aqi,
                            backgroundColor: window.cityData.comparison.aqi.map(aq => getAQIColor(aq)),
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            console.log('‚úÖ Tous les graphiques rendus avec succ√®s');

        } catch (error) {
            console.error('‚ùå Erreur lors du rendu des graphiques:', error);
        }
    }

    // Afficher les stations
    function renderStations() {
        if (!window.cityData || !window.cityData.stations) {
            console.error('Stations non disponibles');
            return;
        }

        const stationsList = document.getElementById('stations-list');
        stationsList.innerHTML = window.cityData.stations.map(station => `
            <div class="station-card" style="border-left-color: ${getAQIColor(station.aqi)}">
                <div class="station-name">${station.name}</div>
                <div class="station-details">
                    <strong>AQI:</strong> ${station.aqi} | 
                    <strong>Statut:</strong> ${station.status}<br>
                    <strong>Derni√®re mise √† jour:</strong> ${station.lastUpdate}
                </div>
            </div>
        `).join('');
    }

    // V√©rifier les alertes
    function checkAlerts() {
        const alertBanner = document.getElementById('alert-banner');
        if (window.cityData && window.cityData.aqiAverage > 300) {
            alertBanner.style.display = 'block';
        } else {
            alertBanner.style.display = 'none';
        }
    }

    // Changer la p√©riode d'analyse
    function changeTimeRange(range) {
        currentTimeRange = range;
        document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        if (cityData) {
            renderDashboard();
        }
    }

    // Fonctions utilitaires
    function getAQIColor(aqi) {
        if (aqi <= 50) return aqiColors.good;
        if (aqi <= 100) return aqiColors.moderate;
        if (aqi <= 200) return aqiColors.poor;
        if (aqi <= 300) return aqiColors.veryPoor;
        return aqiColors.severe;
    }

    function getAQICategory(aqi) {
        if (aqi <= 50) return 'Bon';
        if (aqi <= 100) return 'Mod√©r√©';
        if (aqi <= 200) return 'Mauvais';
        if (aqi <= 300) return 'Tr√®s mauvais';
        return 'S√©v√®re';
    }

    function getAQIClass(aqi) {
        if (aqi <= 50) return 'aqi-good';
        if (aqi <= 100) return 'aqi-moderate';
        if (aqi <= 200) return 'aqi-poor';
        if (aqi <= 300) return 'aqi-very-poor';
        return 'aqi-severe';
    }

    function getDarkenedColor(color) {
        return color; // Simplifi√© pour l'exemple
    }

    </script>
</body>
</html>